name: Test

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  # Trigger on pull requests.
  pull_request:

  # Trigger on pushes to the mainline branches. This prevents building commits twice when the pull
  # request source branch is in the same repository.
  push:
    branches:
      - "master"

  # Trigger on request.
  workflow_dispatch:

  # Weekly builds on the master branch to check that the examples continue to work with the latest
  # development version of HOOMD.
  schedule:
  - cron:  '0 18 * * 1'

jobs:
  execute_notebooks:
    name: Execute notebooks
    runs-on: [self-hosted,jetstream2,CPU]
    container:
      image: glotzerlab/software:nompi
      options: -u 0
    steps:
    # build the HOOMD trunk-minor branch to test the tutorials on the latest version
    - uses: actions/checkout@v2.4.0
      with:
        path: hoomd
        ref: trunk-minor
        repository: glotzerlab/hoomd-blue
        submodules: true
    - name: Make build directory
      run: mkdir build
      working-directory: hoomd
    - name: Configure
      run: >-
        cmake
        -DCMAKE_BUILD_TYPE=Release
        -DENABLE_GPU=off
        -DENABLE_MPI=off
        -DENABLE_TBB=off
        -DBUILD_TESTING=off
        -DBUILD_JIT=off
        ../
      working-directory: hoomd/build
    - name: Compile
      run: make -j $(($(getconf _NPROCESSORS_ONLN) + 2))
      working-directory: hoomd/build
    - name: Display hoomd version
      run: python3 -c "import hoomd; print(hoomd.version.version, hoomd.version.git_sha1)"
      env:
        PYTHONPATH: ${{ github.workspace }}/hoomd/build

    # clone the tutorials and run them
    - uses: actions/checkout@v2.4.0
      with:
        path: notebooks
    - name: List notebooks
      run: ls **/*.ipynb
      working-directory: notebooks
    - name: Execute notebooks
      run: jupyter nbconvert --execute --inplace **/*.ipynb
      working-directory: notebooks
      env:
        PYTHONPATH: ${{ github.workspace }}/hoomd/build

    # notify developers if the scheduled check fails
    - name: Slack notification
      if: ${{ github.event_name == 'schedule' && (failure() || cancelled()) }}
      uses: 8398a7/action-slack@v3.13.0
      with:
        status: ${{ job.status }}
        fields: workflow,job,message,commit
        mention: channel
        if_mention: failure,cancelled
        channel: '#dev-hoomd-notifications'
        username: Github Action
        author_name: ''
        job_name: Execute notebooks
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  start_action_runners:
    name: Start action runners
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.0.2
        with:
          path: code
      - uses: actions/cache@v3.0.2
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-openstacksdk==0.61.0
          restore-keys: |
            ${{ runner.os }}-pip-
      - name: Install openstack
        run: python3 -m pip install openstacksdk==0.61.0
      - name: Start action runners
        run: python3 code/.github/workflows/start-action-runners.py
        env:
          OS_APPLICATION_CREDENTIAL_ID: ${{ secrets.OS_APPLICATION_CREDENTIAL_ID }}
          OS_APPLICATION_CREDENTIAL_SECRET: ${{ secrets.OS_APPLICATION_CREDENTIAL_SECRET }}
          OS_AUTH_TYPE: v3applicationcredential
          OS_AUTH_URL: https://js2.jetstream-cloud.org:5000/v3/
          OS_IDENTITY_API_VERSION: 3
          OS_REGION_NAME: "IU"
          OS_INTERFACE: public
